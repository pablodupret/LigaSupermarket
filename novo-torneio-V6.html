
<!DOCTYPE html>

<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>Torneio Su√≠√ßo - Liga Magic</title>
<link href="style.css" rel="stylesheet"/>
<style>
    body {
      padding: 40px;
      background-color: #121212;
      font-family: sans-serif;
    }

    .container {
      width: 50%;
      max-width: 1000px;
      margin: 0 auto;
      background-color: rgba(20, 20, 20, 0.85);
      padding: 30px;
      border-radius: 15px;
      border: 2px solid #FFD700;
      color: #f5f5dc;
    }

    label, input, textarea {
      display: block;
      width: 100%;
      margin-bottom: 15px;
      font-size: 1em;
      
    }

    textarea {
      height: 80px;
    }

    button {
      background-color: #FFD700;
      color: #000;
      padding: 12px 24px;
      border: none;
      font-size: 1.1em;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #FFD700;
      padding: 10px;
      text-align: center;
    }

    h2, h3 {
      color: #FFD700;
    }

    .rodada-bloco {
      margin-top: 40px;
      padding: 20px;
      background-color: rgba(30, 30, 30, 0.9);
      border: 1px solid #FFD700;
      border-radius: 12px;
    }

    .ranking {
      margin-top: 40px;
    }

    .placar-input {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .placar-input input {
      width: 40px;
      text-align: center;
    }

    

  </style>
</head>
<body>
<div class="container">
<h1>In√≠cio do Torneio</h1>
<label>Data:</label>
<input id="data" type="date"/>
<label>Cole√ß√£o:</label>
<input id="colecao" type="text"/>
<label>Selecione os jogadores:</label>
<div id="lista-jogadores" style="background-color:#2c2c2c;padding:15px;border-radius:10px;max-height:150px;overflow-y:auto;color:#f5f5dc; margin-bottom: 20px;"> Carregando jogadores...</div>
<label> Adicionar novo jogador:</label>
<input id="novo-jogador" type="text"/>
<button onclick="adicionarJogador()" style="margin-bottom: 30px; margin-top: 0px;"> Adicionar</button>
<label>N√∫mero total de rodadas:</label>
<input id="numRodadas" max="10" min="1" type="number"/>
<button onclick="iniciarTorneio()">Iniciar Torneio</button>
</div>
<div class="container" id="torneio-area" style="display:none;"></div>
<!-- Bot√£o para salvar o HTML -->
<button onclick="baixarPagina()">Salvar este Dia (HTML)</button>
<script>
function baixarPagina() {
  const html = document.documentElement.outerHTML;
  const blob = new Blob([html], { type: "text/html" });
  const link = document.createElement("a");
  const nomeArquivo = prompt("Digite o nome do arquivo (ex: dia-03.html):", "dia-03.html") || "dia-x.html";
  link.href = URL.createObjectURL(blob);
  link.download = nomeArquivo;
  link.click();
}
</script>
<!-- Selecionar Jogadores -->
<script>
async function carregarJogadores() {
  try {
    const res = await fetch("jogadores.json");
    const lista = await res.json();
    const div = document.getElementById("lista-jogadores");
    div.innerHTML = "";
    lista.forEach(nome => {
      const id = "jog_" + nome.replace(/\s+/g, "_");
      div.innerHTML += `
        <div style="display: flex; align-items: center; margin-bottom: 0px;">
        <input type="checkbox" value="${nome}" id="${id}" style="width: 16px; height: 16px; margin-right: 6px;" />
        <label for="${id}" style="color: #f5f5dc;">${nome}</label>
       </div>`;

    });
  } catch (err) {
    document.getElementById("lista-jogadores").innerText = "Erro ao carregar jogadores.";
  }
}

function adicionarJogador() {
  const nome = document.getElementById("novo-jogador").value.trim();
  if (!nome) return;
  const id = "jog_" + nome.replace(/\s+/g, "_");
  if (document.getElementById(id)) {
    alert("Jogador j√° est√° na lista.");
    return;
  }
  const div = document.getElementById("lista-jogadores");
  div.innerHTML += `
        <div style="display: flex; align-items: center; margin-bottom: 1px;">
        <input type="checkbox" value="${nome}" id="${id}" style="width: 16px; height: 16px; margin-right: 6px;"  />
        <label for="${id}" style="margin-left: 0px; color: #f5f5dc;">${nome}</label>
        </div>`;
  document.getElementById("novo-jogador").value = "";
}

carregarJogadores();
</script>
<script>
let jogadores = [];
let resultadosPorRodada = {};
let rodadaAtual = 0;
let totalRodadas = 0;
let confrontosAnteriores = new Set();

function iniciarTorneio() {
  const data = document.getElementById("data").value;
  const colecao = document.getElementById("colecao").value;
  const checks = document.querySelectorAll("#lista-jogadores input[type=checkbox]:checked");
  const selecionados = Array.from(checks).map(c => c.value);
  totalRodadas = parseInt(document.getElementById("numRodadas").value);

  if (!data || !colecao || !selecionados.length || !totalRodadas) {
    alert("Preencha todos os campos corretamente.");
    return;
  }

  jogadores = selecionados.map(nome => ({
    nome,
    pontos: 0,
    saldo: 0,
    historico: []
  }));

  rodadaAtual = 0;
  resultadosPorRodada = {};
  confrontosAnteriores = new Set();
  document.getElementById("torneio-area").innerHTML = '';
  document.getElementById("torneio-area").style.display = "block";
  gerarRodada();
}


// Fun√ß√£o para ordena√ß√£o usando crit√©rios do Appendix C
function ordenarJogadoresSuico(jogadores) {
  const stats = jogadores.map(j => {
    let vitorias = 0, empates = 0, derrotas = 0, gamesGanhos = 0, gamesTotais = 0;
    let adversarios = [];

    j.historico.forEach(h => {
      const [g1, g2] = h.placar.replace("(bye)", "").split("x").map(Number);
      if (isNaN(g1) || isNaN(g2)) return;

      gamesGanhos += g1;
      gamesTotais += g1 + g2;

      if (g1 > g2) vitorias++;
      else if (g1 === g2) empates++;
      else derrotas++;

      adversarios.push(h.contra);
    });

    const matchPoints = j.pontos;
    const matchWinPerc = Math.max(0.33, (vitorias * 3 + empates) / ((vitorias + empates + derrotas) * 3 || 1));
    const gameWinPerc = Math.max(0.33, gamesGanhos / (gamesTotais || 1));

    return {
      ...j,
      matchPoints,
      matchWinPerc,
      gameWinPerc,
      adversarios
    };
  });

  // Calcula OMWP
  stats.forEach(s => {
    const lista = s.adversarios.map(nome => {
      const adv = stats.find(j => j.nome === nome);
      return adv ? adv.matchWinPerc : 0.33;
    });
    const media = lista.reduce((a, b) => a + Math.max(0.33, b), 0) / (lista.length || 1);
    s.omwp = media;
  });

  // Embaralha a lista inicialmente
  stats.sort(() => Math.random() - 0.5);

  // Agora ordena com crit√©rios, mantendo aleatoriedade em empates
  stats.sort((a, b) => {
    return b.matchPoints - a.matchPoints ||
           b.omwp - a.omwp ||
           b.matchWinPerc - a.matchWinPerc ||
           b.gameWinPerc - a.gameWinPerc ||
           b.saldo - a.saldo;
  });

  return stats;
}


function gerarRodada() {
  rodadaAtual++;
  const area = document.getElementById("torneio-area");

  const bloco = document.createElement("div");
  bloco.className = "rodada-bloco";
  bloco.id = "rodada_" + rodadaAtual;
  bloco.innerHTML = "<h2>Rodada " + rodadaAtual + "</h2>";

  let jogadoresOrdenados;

if (rodadaAtual === 1) {
  // Primeira rodada: usar ordem aleat√≥ria ou simples
  jogadoresOrdenados = [...jogadores].filter(j => j.nome !== "Bye");
    for (let i = jogadoresOrdenados.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [jogadoresOrdenados[i], jogadoresOrdenados[j]] = [jogadoresOrdenados[j], jogadoresOrdenados[i]];
    }
} else {
  // Demais rodadas: usar ordena√ß√£o do Appendix C
  jogadoresOrdenados = ordenarJogadoresSuico(jogadores.filter(j => j.nome !== "Bye"));
}


  let listaParear = [...jogadoresOrdenados];
  const confrontos = [];

  // Se n√∫mero √≠mpar, sorteia aleatoriamente o jogador com Bye na primeira rodada
  if (listaParear.length % 2 !== 0) {
    let byePlayer;
    if (rodadaAtual === 1) {
      byePlayer = listaParear[Math.floor(Math.random() * listaParear.length)];
    } else {
      byePlayer = listaParear[listaParear.length - 1];
    }
    confrontos.push([byePlayer, { nome: "Bye" }]);
    listaParear = listaParear.filter(j => j.nome !== byePlayer.nome);
    byePlayer.pontos += 3;
    byePlayer.historico.push({ contra: "Bye", placar: "2x0 (bye)" });
    byePlayer.saldo += 2;
  }

  while (listaParear.length >= 2) {
    const j1 = listaParear.shift();
    let indice = listaParear.findIndex(j2 => !confrontosAnteriores.has(j1.nome + "|" + j2.nome));
    if (indice === -1) indice = 0; // se n√£o houver op√ß√£o, permite repeti√ß√£o
    const j2 = listaParear.splice(indice, 1)[0];
    confrontos.push([j1, j2]);
    confrontosAnteriores.add(j1.nome + "|" + j2.nome);
    confrontosAnteriores.add(j2.nome + "|" + j1.nome);
  }

  resultadosPorRodada[rodadaAtual] = confrontos;

  let html = '<table><thead><tr><th>Jogador 1</th><th>Placar</th><th>Jogador 2</th></tr></thead><tbody>';
  confrontos.forEach((par, i) => {
    if (par[1].nome === "Bye") {
      html += `<tr><td colspan="3">${par[0].nome} folga nesta rodada (Bye)</td></tr>`;
    } else {
      html += `
        <tr>
          <td>${par[0].nome}</td>
          <td class="placar-input">
            <input type="number" min="0" id="r${rodadaAtual}_p${i * 2}">
            <span>x</span>
            <input type="number" min="0" id="r${rodadaAtual}_p${i * 2 + 1}">
          </td>
          <td>${par[1].nome}</td>
        </tr>
      `;
    }
  });

  html += '</tbody></table>';
  html += `<button onclick="finalizarRodada(${rodadaAtual})">Finalizar Rodada ${rodadaAtual}</button> <button onclick="reabrirRodada(${rodadaAtual})">Reabrir Rodada</button>`;
  bloco.innerHTML += html;
  area.appendChild(bloco);
}

function finalizarRodada(rodada) {
  const confrontos = resultadosPorRodada[rodada];
  for (let i = 0; i < confrontos.length; i++) {
    const j1 = confrontos[i][0];
    const j2 = confrontos[i][1];
    if (j2.nome === "Bye") continue;

    const p1 = parseInt(document.getElementById(`r${rodada}_p${i * 2}`).value);
    const p2 = parseInt(document.getElementById(`r${rodada}_p${i * 2 + 1}`).value);

    if (isNaN(p1) || isNaN(p2)) {
      alert("Preencha todos os placares antes de finalizar.");
      return;
    }

    const input1 = document.getElementById(`r${rodada}_p${i * 2}`);
    const input2 = document.getElementById(`r${rodada}_p${i * 2 + 1}`);
    const td = input1.parentElement;
    td.innerHTML = `<span>${p1} x ${p2}</span>`;

    if (p1 > p2) j1.pontos += 3;
    else if (p2 > p1) j2.pontos += 3;
    else {
      j1.pontos += 1;
      j2.pontos += 1;
    }

    j1.saldo += p1 - p2;
    j2.saldo += p2 - p1;

    j1.historico.push({ contra: j2.nome, placar: `${p1}x${p2}` });
    j2.historico.push({ contra: j1.nome, placar: `${p2}x${p1}` });
  }

  mostrarRanking();
  mostrarEstatisticasAppendixC();


  if (rodada < totalRodadas) {
    const botao = document.createElement("button");
    botao.textContent = "Gerar Pr√≥xima Rodada";
    botao.onclick = gerarRodada;
    document.getElementById("torneio-area").appendChild(botao);
  } else {
    const fim = document.createElement("h3");
    fim.textContent = "Fim do Torneio!";
    document.getElementById("torneio-area").appendChild(fim);
  }
}


function mostrarRanking() {
  const area = document.getElementById("torneio-area");
  const existente = document.getElementById("ranking-atual");
  if (existente) existente.remove();

  const ranking = jogadores.map(j => {
    let pontos = 0;
    let saldo = 0;

    j.historico.forEach(h => {
      const placar = h.placar.replace("(bye)", "").trim();
      if (!placar.includes("x")) return;

      const [g1, g2] = placar.split("x").map(Number);
      if (isNaN(g1) || isNaN(g2)) return;

      if (g1 > g2) pontos += 3;
      else if (g1 < g2) pontos += 0;
      else pontos += 1;

      saldo += g1 - g2;
    });

    return {
      nome: j.nome,
      pontos,
      saldo
    };
  }).filter(j => j.nome !== "Bye");

  ranking.sort((a, b) => {
    return b.pontos - a.pontos || b.saldo - a.saldo;
  });

  let html = "<div class='ranking' id='ranking-atual'><h3>Ranking Atual</h3><table><tr><th>Jogador</th><th>Pontos</th><th>Saldo</th></tr>";
  ranking.forEach(j => {
    html += `<tr><td>${j.nome}</td><td>${j.pontos}</td><td>${j.saldo}</td></tr>`;
  });
  html += "</table></div>";
  area.innerHTML += html;
}






function reabrirRodada(rodada) {
  const confrontos = resultadosPorRodada[rodada];

  // Remove pontos e saldo da rodada anterior
  confrontos.forEach((par, i) => {
    if (par[1].nome === "Bye") return;
    const j1 = jogadores.find(j => j.nome === par[0].nome);
    const j2 = jogadores.find(j => j.nome === par[1].nome);
    const resultado = j1.historico.find(h => h.contra === j2.nome && h.placar.includes("x"));
    if (!resultado) return;

    const [g1, g2] = resultado.placar.split("x").map(Number);
    if (g1 > g2) j1.pontos -= 3;
    else if (g2 > g1) j2.pontos -= 3;
    else {
      j1.pontos -= 1;
      j2.pontos -= 1;
    }
    j1.saldo -= g1 - g2;
    j2.saldo -= g2 - g1;

    // Remove do hist√≥rico
    j1.historico = j1.historico.filter(h => h.contra !== j2.nome);
    j2.historico = j2.historico.filter(h => h.contra !== j1.nome);
  });

  // Criar nova rodada com mesmo n√∫mero
  const area = document.getElementById("torneio-area");
  const bloco = document.createElement("div");
  bloco.className = "rodada-bloco";
  bloco.id = "rodada_" + rodada + "_reaberta";
  bloco.innerHTML = `<h2>Rodada ${rodada} (Reaberta)</h2>`;

  let html = '<table><thead><tr><th>Jogador 1</th><th>Placar</th><th>Jogador 2</th></tr></thead><tbody>';
  confrontos.forEach((par, i) => {
    if (par[1].nome === "Bye") {
      html += `<tr><td colspan="3">${par[0].nome} folga nesta rodada (Bye)</td></tr>`;
    } else {
      html += `
        <tr>
          <td>${par[0].nome}</td>
          <td class="placar-input">
            <input type="number" min="0" id="r${rodada}_p${i * 2}_r">
            <span>x</span>
            <input type="number" min="0" id="r${rodada}_p${i * 2 + 1}_r">
          </td>
          <td>${par[1].nome}</td>
        </tr>
      `;
    }
  });
  html += '</tbody></table>';
  html += `<button onclick="finalizarRodadaReaberta(${rodada})">Finalizar Rodada ${rodada} (Reaberta)</button>`;
  bloco.innerHTML += html;
  area.appendChild(bloco);
  alert("Rodada reaberta! Corrija os placares e finalize novamente.");
}

// Fun√ß√£o para finalizar rodada reaberta

function finalizarRodadaReaberta(rodada) {
  const confrontos = resultadosPorRodada[rodada];
  for (let i = 0; i < confrontos.length; i++) {
    const j1 = confrontos[i][0];
    const j2 = confrontos[i][1];
    if (j2.nome === "Bye") continue;

    const p1 = parseInt(document.getElementById(`r${rodada}_p${i * 2}_r`).value);
    const p2 = parseInt(document.getElementById(`r${rodada}_p${i * 2 + 1}_r`).value);

    if (isNaN(p1) || isNaN(p2)) {
      alert("Preencha todos os placares antes de finalizar.");
      return;
    }

    const input1 = document.getElementById(`r${rodada}_p${i * 2}_r`);
    const input2 = document.getElementById(`r${rodada}_p${i * 2 + 1}_r`);
    const td = input1.parentElement;
    td.innerHTML = `<span>${p1} x ${p2}</span>`;

    if (p1 > p2) j1.pontos += 3;
    else if (p2 > p1) j2.pontos += 3;
    else {
      j1.pontos += 1;
      j2.pontos += 1;
    }

    j1.saldo += p1 - p2;
    j2.saldo += p2 - p1;

    j1.historico.push({ contra: j2.nome, placar: `${p1}x${p2}` });
    j2.historico.push({ contra: j1.nome, placar: `${p2}x${p1}` });
  }

  mostrarRanking();
  mostrarEstatisticasAppendixC();

  if (rodada < totalRodadas) {
    const botao = document.createElement("button");
    botao.textContent = "Gerar Pr√≥xima Rodada";
    botao.onclick = gerarRodada;
    document.getElementById("torneio-area").appendChild(botao);
  } else {
    const fim = document.createElement("h3");
    fim.textContent = "Fim do Torneio!";
    document.getElementById("torneio-area").appendChild(fim);
  }
}


//Fun√ß√£o para calculo do Appendix_c

function mostrarEstatisticasAppendixC() {
  const area = document.getElementById("torneio-area");
  const existente = document.getElementById("appendix-c");
  if (existente) existente.remove(); // Remove tabela anterior

  const stats = jogadores.map(j => ({
    nome: j.nome,
    matchPoints: 0,
    vitorias: 0,
    empates: 0,
    derrotas: 0,
    gamesGanhos: 0,
    gamesTotais: 0,
    adversarios: []
  }));

  const statsMap = Object.fromEntries(stats.map(s => [s.nome, s]));

  jogadores.forEach(j => {
    const s = statsMap[j.nome];
    j.historico.forEach(h => {
      const adversario = h.contra;
      const placar = h.placar.replace("(bye)", "").trim();
      if (!placar.includes("x")) return;

      const [g1, g2] = placar.split("x").map(Number);
      if (isNaN(g1) || isNaN(g2)) return;

      const sAdv = statsMap[adversario];
      if (adversario !== "Bye" && !s.adversarios.includes(adversario)) {
        s.adversarios.push(adversario);
      }

      s.gamesGanhos += g1;
      s.gamesTotais += g1 + g2;

      if (g1 > g2) {
        s.vitorias++;
        s.matchPoints += 3;
      } else if (g1 < g2) {
        s.derrotas++;
      } else {
        s.empates++;
        s.matchPoints += 1;
      }
    });
  });

  // C√°lculo dos percentuais
  stats.forEach(s => {
    const totalMatches = s.vitorias + s.empates + s.derrotas;
    s.matchWinPerc = Math.max(0.33, (s.vitorias * 3 + s.empates) / ((totalMatches * 3) || 1));
    s.gameWinPerc = Math.max(0.33, s.gamesGanhos / (s.gamesTotais || 1));
  });

  // C√°lculo do OMWP
  stats.forEach(s => {
    const lista = s.adversarios.map(nome => {
      const adv = statsMap[nome];
      return adv ? adv.matchWinPerc : 0.33;
    });
    const media = lista.reduce((a, b) => a + b, 0) / (lista.length || 1);
    s.omwp = Math.max(0.33, media);
  });

  // Exibir a tabela
  let html = `<div class='ranking' id='appendix-c'>
    <h3>üìä Estat√≠sticas Avan√ßadas (Appendix C)</h3>
    <table><tr><th>Jogador</th><th>MP</th><th>MW%</th><th>GW%</th><th>OMWP</th></tr>`;

      stats.forEach(s => {
    html += `<tr>
      <td>${s.nome}</td>
      <td>${s.matchPoints}</td>
      <td>${(s.matchWinPerc * 100).toFixed(1)}%</td>
      <td>${(s.gameWinPerc * 100).toFixed(1)}%</td>
      <td>${(s.omwp * 100).toFixed(1)}%</td>
    </tr>`;
  });

  html += "</table>";

  // üîç Identifica o campe√£o com base nos crit√©rios oficiais
  const campeao = [...stats]
    .sort((a, b) =>
      b.matchPoints - a.matchPoints ||
      b.omwp - a.omwp ||
      b.matchWinPerc - a.matchWinPerc ||
      b.gameWinPerc - a.gameWinPerc ||
      (jogadores.find(j => j.nome === b.nome)?.saldo || 0) -
      (jogadores.find(j => j.nome === a.nome)?.saldo || 0)
    )[0];

  html += `
    <h3 style="margin-top: 30px; color: gold;">üèÜ Campe√£o: ${campeao.nome}</h3>
  </div>`;

  area.innerHTML += html;
}


function exportarResultadosParaJSON() {
  const jogosExportados = [];
  const numeroDia = prompt("Digite o n√∫mero do dia (ex: 5):", "5");
  if (!numeroDia) return;

  for (const rodada in resultadosPorRodada) {
    const confrontos = resultadosPorRodada[rodada];
    confrontos.forEach((par, i) => {
      const j1 = par[0];
      const j2 = par[1];

      if (j2.nome === "Bye") return;

      // Identifica o elemento da c√©lula com placar
      const linhaIndex = i;
      const blocoRodada = document.getElementById(`rodada_${rodada}`) || document.getElementById(`rodada_${rodada}_reaberta`);
      if (!blocoRodada) return;

      const placarCells = blocoRodada.querySelectorAll("tbody tr");
      const linha = placarCells[linhaIndex];
      if (!linha) return;

      const placarSpan = linha.querySelector("td.placar-input, td span");
      if (!placarSpan) return;

      const texto = placarSpan.innerText || "";
      const [p1, p2] = texto.replace("(bye)", "").split("x").map(str => parseInt(str.trim()));
      if (isNaN(p1) || isNaN(p2)) return;

      

      jogosExportados.push({
      dia: parseInt(numeroDia),
      rodada: parseInt(rodada),
      jogador1: j1.nome,
      jogador2: j2.nome,
      resultado: `${p1} x ${p2}`
      });

    });
  }

  const blob = new Blob([JSON.stringify(jogosExportados, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "resultados_28-07-2025.json";
  link.click();
}





</script></body>

<button onclick="exportarResultadosParaJSON()">üì§ Exportar Resultados (JSON)</button>


</html>
